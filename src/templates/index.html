{% extends "layout.html" %}

{% block title %}
Citation app
{% endblock %}

{% block body %}

<h1>Citation helper</h1>

{% with messages = get_flashed_messages() %}
{% if messages %}
  <ul>
  {% for message in messages %}
    <li>{{ message }}</li>
  {% endfor %}
  </ul>
{% endif %}
{% endwith %}

<form action="/" method="post">
  <select name="citation_type" required>
    {% for ctype in all_citation_types %}
      <option value="{{ ctype }}" {% if ctype == citation_type %}selected{% endif %}>{{ ctype }}</option>
    {% endfor %}
  </select>

  <input type="submit" value="Select">
</form>

{% if citation_type %}
  <h2>{{ citation_type }}</h2>

  <form action="/create_citation" method="post">
    <label for="content">Enter a new citation:</label>
    <input type="hidden" name="citation_type" value="{{ citation_type }}">
    <br/>
    <p>Required fields:</p>
    {% for field in all_citation_types[citation_type]["required"] %}
    <input type="text" name="{{ field }}" placeholder="{{ field }}" required>
    <br>
    {% endfor %}
    
    <p>Optional fields:</p>
    {% for field in all_citation_types[citation_type]["optional"] %}
    <input type="text" name="{{ field }}" placeholder="{{ field }}">
    <br>
    {% endfor %}
    
    <button type="submit">
      Create
    </button>
  </form>

{% endif %}

<h4>Citations:</h4>
<input type="text" id="filter" placeholder="Filter citations" />
<ul id="citationlist">
  {% for citation in citations %}
  <li style="margin-bottom: 1rem;" name="{{ citation.fields['title'] }}">
    {% if citation.id == editing_id %}

      <p><b>Editing</b> {{ citation }}:</p>
        {# Changing citation type is currently not supported #}
        <p>Citation type: {{ citation.citation_type }}</p>
        <form action="/update_citation" method="post">
        <input type="hidden" name="citation_id" value="{{ citation.id }}">
        <p>Required fields:</p>
        {% for field in all_citation_types[citation.citation_type]["required"] %}
          <input type="text" name="{{ field }}"
           {% if field in citation.fields %}
           value="{{ citation.fields[field] }}"
           {% endif %}
           placeholder="{{ field }}" required />
          <br>
        {% endfor %}
        <p>Optional fields:</p>
        {% for field in all_citation_types[citation.citation_type]["optional"] %}
          <input type="text" name="{{ field }}"
           {% if field in citation.fields %}
           value="{{ citation.fields[field] }}"
           {% endif %}
           placeholder="{{ field }}" />
          <br>
        {% endfor %}
        <input type="submit" value="Submit">
        </form>

    {% else %}

    <details>
      <summary>
        <span class="citation_title">{{citation}}</span>
        <form action="/delete_citation" method="post">
          <input type="hidden" name="citation_id" value="{{ citation.id }}">
          <input type="submit" value="Delete">
        </form>
        <form action="/" method="post">
          <input type="hidden" name="editing_id" value="{{ citation.id }}">
          <input type="submit" value="Edit">
        </form>
      </summary>
      <div style="margin-left: 20px; margin-top: 5px;">
        {% for field in citation.fields %}
          <p><strong>{{ field.capitalize() }}:</strong> {{ citation.fields[field] }}</p>
        {% endfor %}
      </div>
    </details>

    {% endif %}
  </li>
  {% endfor %}
</ul>

<script>
  document.getElementById('filter').addEventListener('input', function(){
    console.log(this.value)
    const filter = (this.value).toLowerCase();
    const items = document.querySelectorAll('#citationlist li');


    items.forEach(function(item) {
      console.log(item)
      const title = item.querySelector('.citation_title').textContent.toLowerCase();
      console.log(title)
      if (title.includes(filter)) {
        item.style.display = '';
      } else {
        item.style.display = 'none';
      }
    })
  })


</script>

<div style="margin-top: 1rem;">
  <form action="/export_citations" method="post" onsubmit="MyFunction()">
    <input type="text" name="bibname" placeholder="Bib file name">
    <br/>
    <button type="submit">
      Generate Bib file
    </button>
  </form>
</div>

<script>
  function MyFunction() {
    alert("The Bibtex file has been generated and can be found in the directory 'data'");
  }
</script>

{% endblock %}